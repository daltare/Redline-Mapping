---
title: "Redlining Analysis"
# author: "David"
date: "*Updated: `r format(Sys.Date())`*"
# output: html_document
output:
  html_document:
    code_folding: hide
    toc: TRUE
    toc_float: TRUE
    toc_depth: 5
---
## Introduction
This document attempts to do some quantitative geospatial analysis to look at correlations between redline mapping and indicators of water quality, public health, and facility information.

```{r setup, include=FALSE, echo=FALSE}
    knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, error = FALSE)
```


```{r load packages and data}
    # General data analysis and transformation
        library(readr)
        library(readxl)
        library(dplyr)
        library(janitor)
        # library(gtools)
        library(stringr)
        library(units)
        library(tidyr)
    # API-related
        library(jsonlite)
        library(urltools)
    # Mapping and GIS operations
        library(sf)
        library(leaflet)
        library(htmlwidgets)
        library(geojsonsf)
        library(rmapshaper)
        library(tmap)
        library(tmaptools)
        library(ceramic)
    # workflow
        library(here)
    # plotting
        library(ggplot2)
        library(forcats)

    # load data
        # Redline Polygons
            redline_polygons <- read_rds(here('data_prepared', 'redline_polygons.RDS'))
                # st_crs(redline_polygons) # to check the reference system
            # modify the 'city' column to better keep track when joining with other datasets
                redline_polygons <- redline_polygons %>% rename('redline_city' = 'city')
            # add the area of each redline polygon
                redline_polygons <- redline_polygons %>% mutate(redline_poly_area = st_area(.))
    
        # CES 3 Polygons
            ces_3_poly <- read_sf(here('data_raw', 'CalEnviroScreen3', 'CESJune2018Update_SHP','CES3June2018Update.shp'))
                # st_crs(ces_3_poly) # to check the reference system
            # modify the 'City' column to better keep track when joining with other datasets
                ces_3_poly <- ces_3_poly %>% rename('CES_City' = 'City')
                
        # Transform both to UTM Zone 10N
            redline_polygons <- redline_polygons %>% st_transform(crs = 26910)
            ces_3_poly <- ces_3_poly %>% st_transform(crs = 26910)
            
    # create a map to check that the data loaded correctly
        # tm_shape(ces_3_poly) + tm_borders() + tm_shape(redline_polygons) + tm_borders(col = 'red')
```


## Area Weighted Average CES Percentiles
This looks at the area weighed average CES percentile by HOLC rating for a given city and statewide.  
  
The CES polygons and the Redline polygons have different coverages, as shown in the figure below. The left pane shows the HOLC rated areas, the center pane shows the CES scores (at the census tract level) with the Redlined areas superimposed on top, and the right pane shows the overlapping portions of the CES polygons and the redlined areas (labels represent HOLC rating).
```{r CES3-Redline Intersection in Sacramento, fig.cap='**Figure 1. HOLC rated areas and CES Scores in Sacramento.**'}
    # get a basemap (See: https://github.com/mtennekes/tmap/issues/185)
        Sys.setenv(MAPBOX_API_KEY = "pk.eyJ1IjoiZGFsdGFyZSIsImEiOiJjazZqcm5ocHgwMG84M2tteGc5eWd4YXNmIn0.nHiYenoq-wFWwH3V4vtPXA")
        background <- cc_location(ces_3_poly %>% filter(CES_City == 'Sacramento'), verbose = FALSE)
        
    # create map
        map_redline <- tm_shape(background) + 
            tm_rgb(alpha = 0.5) + 
            tm_shape(redline_polygons %>% filter(redline_city == 'Sacramento'), is.master = TRUE) + 
            tm_polygons('holc_grade', palette = c('green', 'blue', 'yellow', 'red'), title = 'HOLC Grade') + 
            tm_layout(legend.bg.color = 'white', legend.bg.alpha = 0.7, legend.frame = TRUE)
        # map_redline

    # get the intersection of the CES polygons and redline polygons
        ces3_redline_intersection <- st_intersection(ces_3_poly, redline_polygons)

    # inspect
        # glimpse(ces3_redline_intersection)

    # plot the CES polygons
        map_ces <- tm_shape(background) + 
            tm_rgb(alpha = 0.5) + 
            tm_shape(ces_3_poly %>% filter(CES_City == 'Sacramento' | CES_City == 'West Sacramento')) + 
            tm_polygons(col = 'CIscoreP', title = 'CES Percentile', border.alpha = 1) + 
            tm_shape(ces3_redline_intersection %>% filter(redline_city == 'Sacramento'), is.master = TRUE) +
            tm_borders(lwd = 0, alpha = 0) +
            tm_shape(redline_polygons %>% filter(redline_city == 'Sacramento')) +
            tm_borders(lwd = 2, col = 'black') +
            # tm_text('holc_grade', size = 0.5) + 
            tm_layout(legend.bg.color = 'white', legend.bg.alpha = 0.7, legend.frame = TRUE)
        # map_ces
    
    # plot the overlap
        map_overlap <- tm_shape(background) + 
            tm_rgb(alpha = 0.5) + 
            tm_shape(ces_3_poly %>% filter(CES_City == 'Sacramento')) + 
            tm_borders(lwd = 1) + 
            tm_shape(ces3_redline_intersection %>% filter(redline_city == 'Sacramento'), is.master = TRUE) + 
            tm_polygons(col = 'CIscoreP', title = 'CES Percentile', border.alpha = 0) + 
            tm_shape(redline_polygons %>% filter(redline_city == 'Sacramento')) + 
            tm_borders(lwd = 2, col = 'black') + 
            tm_text('holc_grade', size = 0.5) + 
            tm_layout(legend.bg.color = 'white', legend.bg.alpha = 0.7, legend.frame = TRUE)
        #map_overlap
        
        tmap_arrange(map_redline, map_ces, map_overlap, nrow = 1)
```

To better see the CES scores by HOLC grade, try separating the HOLC grades into separate panes.
```{r facet plot, fig.cap='**Figure 2. CES Scores for Redlined Areas in Sacramento, by HOLC rating class.**'}
    # map
        map_facets <- tm_shape(ces_3_poly %>% filter(CES_City == 'Sacramento')) + 
            tm_borders(lwd = 1) + 
            tm_shape(background) + 
            tm_rgb(alpha = 0.5) +
            tm_shape(ces3_redline_intersection %>% filter(redline_city == 'Sacramento'), is.master = TRUE) +
            # tm_shape(ces3_redline_intersection %>% filter(redline_city == 'Sacramento')) + 
            tm_facets(by = 'holc_grade', free.coords = FALSE) + 
            tm_polygons(col = 'CIscoreP', title = 'CES Percentile', border.alpha = 0) #+ 
            # tm_shape(redline_polygons %>% filter(redline_city == 'Sacramento')) + tm_facets(by = 'holc_grade') +
            # tm_borders(lwd = 2, col = 'black')  +
            # tm_text('holc_grade', size = 0.5) +
            #tm_legend(bg.color= 'white', frame = TRUE)
        
        map_facets


# tm_facets(by="province")
```

### CES Percentile Area Weighted Averages
Compute the area weighted average scores by HOLC grade for each city and statewide.
```{r Area Weighed Average By City}
    # add the area of each clipped polygon to the data frame
        ces3_redline_intersection <- ces3_redline_intersection %>% mutate(clipped_area = st_area(.))
            # glimpse(ces3_redline_intersection)
        
    # group by city and holc rating, then compute the weighted average score for each
        ces3_redline_grouped <- ces3_redline_intersection %>% 
            st_drop_geometry() %>%
            mutate(area_x_score = clipped_area * CIscoreP) %>% 
            group_by(redline_city, holc_grade) %>% 
            summarize(total_area = sum(clipped_area), area_x_score_total = sum(area_x_score)) %>% 
            mutate(weighted_score = area_x_score_total / total_area) %>% 
            drop_units()
            
            # glimpse(ces3_redline_grouped)
            
    # plot the results by city and holc rating
        g_city <- ggplot(ces3_redline_grouped) + 
            aes(x = fct_reorder(redline_city, weighted_score), y = weighted_score, fill = fct_rev(holc_grade)) + 
            geom_bar(stat = 'identity', position = 'dodge') + 
            scale_fill_manual(values = rev(c('green', 'blue', 'yellow', 'red'))) + 
            guides(fill = guide_legend(reverse = TRUE)) +
            labs(fill = 'HOLC Rating', x = NULL, y = "Area Weighted Average Score By City") + 
            coord_flip()
        # g_city
        
    # # plot the results by city and holc rating -- faceting
    #     g_city <- ggplot(ces3_redline_grouped) + 
    #         aes(x = fct_reorder(redline_city, weighted_score), y = weighted_score, fill = fct_rev(holc_grade)) + 
    #         geom_bar(stat = 'identity', position = 'dodge') + 
    #         scale_fill_manual(values = rev(c('green', 'blue', 'yellow', 'red'))) + 
    #         guides(fill = guide_legend(reverse = TRUE)) +
    #         labs(fill = 'HOLC Rating', x = NULL, y = "Area Weighted Average Score By City") + 
    #         coord_flip()
    #         
    #     g_city
```
   
```{r Area Weighed Average By City -- Alternate Method (to check), eval=FALSE, include=FALSE} 
    # Method 2 - as a check
        # 1 - compute the area of each redline polygon, then group redline polygons by city and HOLC grade, then compute total area of grouped polygons
            redline_polys_grouped_city <- redline_polygons %>% 
                group_by(redline_city, holc_grade) %>% 
                summarize(full_area = sum(redline_poly_area))
            # map to check
                # tm_shape(redline_polys_grouped_city %>% filter(redline_city == 'Sacramento')) + tm_polygons('holc_grade')
        # 2 - Get the intersection of the (grouped) redline polygons and the CES polygons
            ces3_redline_intersection_grouped_city <- st_intersection(ces_3_poly, redline_polys_grouped_city) %>% 
                mutate(partial_area = st_area(.)) %>% 
                mutate(proportional_area = partial_area / full_area) %>% 
                mutate(proportional_score = proportional_area * CIscoreP)
            # # map to check
            #     tm_shape(ces3_redline_intersection_grouped_city %>% 
            #                  filter(redline_city == 'Sacramento', holc_grade == 'A')) + 
            #         tm_polygons('proportional_area')
            # # check the results for one holc grade in one city
            #     avg_check <- ces3_redline_intersection_grouped_city %>% 
            #         filter(redline_city == 'Sacramento', holc_grade == 'A') %>% 
            #         select(full_area, partial_area, proportional_area, CIscoreP, proportional_score)
            #     View(avg_check %>% arrange(desc(proportional_area)))
            #     # percent difference between summed partial areas and full area - should be close to zero
            #         (sum(avg_check$partial_area)-median(avg_check$full_area))/median(avg_check$full_area) * 100
            #     # sum of the proportional areas - should be close to 1
            #         sum(avg_check$proportional_area) 
            #     # weighed average score - make sure it's within the range of the raw scores
            #         sum(avg_check$proportional_score)
            #         range(avg_check$CIscoreP)
        # 3 - re-group by city and HOLC grade and sum the proportional scores
            weighted_avg_scores_city <- ces3_redline_intersection_grouped_city %>% 
                group_by(redline_city, holc_grade) %>% 
                summarize(weighed_avg_score = sum(proportional_score)) %>% 
                drop_units() %>% 
                st_drop_geometry()
            # View(weighted_avg_scores_city)
        # 4 - plot the results by city and holc rating
            g_city_2 <- ggplot(weighted_avg_scores_city) + 
                aes(x = fct_reorder(redline_city, weighed_avg_score), y = weighed_avg_score, fill = fct_rev(holc_grade)) + 
                geom_bar(stat = 'identity', position = 'dodge') + 
                scale_fill_manual(values = rev(c('green', 'blue', 'yellow', 'red'))) + 
                guides(fill = guide_legend(reverse = TRUE)) +
                labs(fill = 'HOLC Rating', x = NULL, y = "Area Weighted Average Score By City") + 
                coord_flip()
            # g_city_2
            
        # compare
            # weighted_avg_scores_city %>% # method 2
            #     left_join(ces3_redline_grouped %>% select(redline_city, holc_grade, weighted_score)) # method 1

```

```{r Statewide Area Weighed Average, fig.height=1.5, eval=FALSE, include=FALSE}
### Statewide Area Weighted Averages
# Compute the statewide area weighted average by HOLC grade.

    # compute weighted average score for all redlined areas statewide by holc rating
        ces3_redline_grouped_statewide <- ces3_redline_grouped %>% 
            group_by(holc_grade) %>% 
            summarize(statewide_area = sum(total_area), 
                      statewide_area_x_score = sum(area_x_score_total)) %>% 
            mutate(statewide_weighted_score = statewide_area_x_score / statewide_area) %>% 
            drop_units()
        
        # glimpse(ces3_redline_grouped_statewide)
        
    # plot the statewide results by holc rating
        g_statewide <- ggplot(ces3_redline_grouped_statewide) + 
            aes(x = fct_rev(holc_grade), y = statewide_weighted_score, fill = holc_grade) + 
            geom_bar(stat = 'identity') + ylim(0,100) +
            scale_fill_manual(values = c('green', 'blue', 'yellow', 'red')) + 
            labs(fill = 'HOLC Rating', x = 'Statewide', y = "Area Weighted Average Score") + 
            theme(axis.title.y = element_text(angle = 0, vjust = 0.5, hjust = 0), 
                  axis.text.y = element_blank(), 
                  axis.ticks.y = element_blank()) +
            coord_flip()
        g_statewide
```

```{r city plus statewide plot, fig.cap='**Figure 3. Area Weighted Average CES Percentiles for each city and statwide, by HOLC rating class.**'}
    ces3_redline_grouped_both <- ces3_redline_grouped %>%
            group_by(holc_grade) %>%
            summarize(total_area = sum(total_area),
                      area_x_score_total = sum(area_x_score_total)) %>%
            mutate(weighted_score = area_x_score_total / total_area) %>%
            mutate(redline_city = '**Statewide**') %>%
            drop_units()

    ces3_redline_grouped_both <- bind_rows(ces3_redline_grouped, ces3_redline_grouped_both)

    # plot the results by city and holc rating, and include statewide summary
        g_both <- ggplot(ces3_redline_grouped_both) +
            aes(x = fct_relevel(fct_reorder(redline_city, weighted_score), c('**Statewide**'), after = 0), y = weighted_score, fill = fct_rev(holc_grade)) +
            geom_bar(stat = 'identity', position = 'dodge') +
            geom_vline(xintercept = 1.52, size = 0.5, color = 'grey50') +
            scale_fill_manual(values = rev(c('green', 'blue', 'yellow', 'red'))) +
            guides(fill = guide_legend(reverse = TRUE)) +
            labs(fill = 'HOLC Rating', x = NULL, y = "Area Weighted Average Score By City") +
            coord_flip()

        g_both
```

## Facility Density and Violation / Enforcement Action Rates
Compute the density of facilities regulated by the California State Water Resources Control Board (number per unit area) by HOLC grade for each city and statewide, and the rate of violations and enforcement actions (total number of records per unit area). Facilities from CIWQS, SMARTS, and GeoTracker are included in this analysis.
```{r get facility data}
    # import data
        facilities_programs <- read_rds(here('data_prepared', 'cal_epa_sites_programs.RDS'))
        violations_count <- read_rds(here('data_prepared', 'cal_epa_sites_violations_count.RDS'))
        enforcement_count <- read_rds(here('data_prepared', 'cal_epa_sites_enforcement_count.RDS'))

    # get CalEPA sites data from the geoserver api
        # construct and make the api call
            calepa_sites_typenames <- list('California Integrated Water Quality System (CIWQS)' = 'calepa:mv_fac_from_ciwqs',
                                           'GeoTracker' = 'calepa:mv_fac_from_geotracker',
                                           'Storm Water Multiple Application and Report Tracking System (SMARTS)' = 'calepa:mv_fac_from_smarts',
                                           'Chemical Hazards - Fire' = 'calepa:mv_fac_chem_summary_fire',
                                           'Chemical Hazards - Reactivity' = 'calepa:mv_fac_chem_summary_reactive',
                                           'Chemical Hazards - Sudden Release of Pressure' = 'calepa:mv_fac_chem_summary_sudden_rel',
                                           'California Environmental Reporting System (CERS)' = 'calepa:mv_fac_from_cers',
                                           'EnviroStor Cleanup (ENVSTORCLN)' = 'calepa:mv_fac_from_envstorcln',
                                           'EnviroStor Hazardous Waste (ENVSTORHAZ)' = 'calepa:mv_fac_from_envstorhaz',
                                           'National Emissions Inventory System (EIS)' = 'calepa:mv_fac_from_frs',
                                           'Toxic Release Inventory (TRI)' = 'calepa:mv_fac_from_tri'
                                           )
            site_types_get <- c('California Integrated Water Quality System (CIWQS)', 'GeoTracker', 'Storm Water Multiple Application and Report Tracking System (SMARTS)')
            counter_sites <- 0
            for (site_type in site_types_get) {
                counter_sites <- counter_sites + 1
                url_sites_api <- paste0('https://services.calepa.ca.gov/geoserver/calepa/',
                                           'ows?service=WFS&version=1.0.0',
                                           '&request=GetFeature',
                                           '&typeName=', calepa_sites_typenames[[site_type]],
                                           '&outputFormat=application%2Fjson')
    
                api_output <- readr::read_lines(url_sites_api)
                json_list <- jsonlite::fromJSON(api_output)
                df_api_result <- json_list$features
                df_api_result <- df_api_result %>% mutate('data_source' = site_type)
                # reformat the data frame (some of it is nested)
                    df_api_result <- bind_cols(df_api_result %>% select(id, data_source),
                                               df_api_result$geometry,
                                               df_api_result$properties)
                if (counter_sites == 1) {
                    cal_epa_sites <- df_api_result
                } else {
                    cal_epa_sites <- bind_rows(cal_epa_sites, df_api_result)
                }
            }
            
            # rename the city column (to keep track when joining to other datasets)
                cal_epa_sites <- cal_epa_sites %>% rename('facility_city' = 'city')
            
            # join the violation and enforcement record counts to the sites data frame
                cal_epa_sites <- cal_epa_sites %>% left_join(violations_count, by = c('site_id' = 'SiteID'))
                cal_epa_sites <- cal_epa_sites %>% left_join(enforcement_count, by = c('site_id' = 'SiteID'))
            # replace NAs with zeros for the counts
                cal_epa_sites <- cal_epa_sites %>% mutate(violations_records = case_when(is.na(violations_records) ~ 0L,
                                                                                       TRUE ~ violations_records),
                                                          enforcement_records = case_when(is.na(enforcement_records) ~ 0L,
                                                                                       TRUE ~ enforcement_records))
            # Create an sf object from the sites data
                cal_epa_sites <- st_as_sf(cal_epa_sites %>% filter(!is.na(latitude) & !is.na(longitude)),
                                          coords = c('longitude', 'latitude'),
                                          crs = 4326,
                                          agr = 'constant')
            # Transform to UTM Zone 10N
                cal_epa_sites <- cal_epa_sites %>% st_transform(crs = 26910) 
                
            # shorten the 'data_source' field (for mapping)
                cal_epa_sites <- cal_epa_sites %>% 
                    mutate(data_source = case_when(data_source == 'California Integrated Water Quality System (CIWQS)' ~ 'CIWQS',
                                                   data_source == 'GeoTracker' ~ 'GeoTracker',
                                                   data_source == 'Storm Water Multiple Application and Report Tracking System (SMARTS)' ~ 'SMARTS',
                                                   TRUE ~ data_source))
            
            # clip the CES3 polygons to the redline polygons
                # ces3_redline_intersection <- st_intersection(ces_3_poly, redline_polygons) %>% mutate(area = st_area(.))   
            
            # # map sacramento
            #     map_facilities_all <- tm_shape(redline_polygons %>% filter(redline_city == 'Sacramento'), is.master = TRUE) + 
            #         tm_borders() +
            #         tm_shape(cal_epa_sites %>% filter(facility_city == 'SACRAMENTO')) + 
            #         # tm_dots(col = 'data_source', size = 0.2, pal = 'viridis', border.col = 'black', border.lwd = 1) + 
            #         tm_symbols(col = 'data_source', size = 0.2, border.col = 'black', border.lwd = 1, alpha = 1, pal = 'viridis') +
            #         # pal = scales::hue_pal()(3)) +
            #         # c('red', 'green', 'blue')) + 
            #         tm_layout(legend.bg.color = 'white', legend.bg.alpha = 0.9, legend.frame = TRUE)
            #     # map_facilities_all
                
            # filter for sites within a redline polygon
                cal_epa_sites_int <- st_intersection(cal_epa_sites, redline_polygons)
                # # plot
                #     map_facilities_int <- tm_shape(redline_polygons %>% filter(redline_city == 'Sacramento'), is.master = TRUE) +
                #         tm_polygons('holc_grade', palette = c('green', 'blue', 'yellow', 'red'), title = 'HOLC Grade', alpha = 0.5) +
                #         tm_shape(cal_epa_sites_int %>% filter(redline_city == 'Sacramento')) + 
                #         # tm_dots(col = 'data_source', size = 0.2, pal = 'viridis', border.col = 'black', border.lwd = 1) + 
                #         tm_symbols(col = 'data_source', 
                #                    size = 0.2, 
                #                    border.col = 'black', 
                #                    border.lwd = 1, 
                #                    alpha = 1, 
                #                    pal = 'viridis',
                #                    # shape = c(1,2,3)
                #                    ) +
                #         # pal = scales::hue_pal()(3)) +
                #         # c('red', 'green', 'blue')) + 
                #         tm_layout(legend.bg.color = 'white', legend.bg.alpha = 0.9, legend.frame = TRUE)

                # tmap_arrange(map_facilities_all, map_facilities_int, nrow = 1)
```

```{r facility density and violations/enforcements by city}
            # Facility density and violation/enforcement rates (per facility and per unit area) by city
                # get the total area of each holc type by city
                    redline_polygons_city_areas <- redline_polygons %>% 
                        group_by(redline_city, holc_grade) %>% 
                        summarize(redline_city_area_m2 = sum(redline_poly_area)) %>%
                        mutate(redline_city_area_mi2 = redline_city_area_m2 / 2589988) %>% 
                        st_drop_geometry() %>% 
                        drop_units()
                    
                    
                # # group by city, holc grade, and data source (facility type), then get the facility counts and violations/enforcement counts, and finally compute density
                #     cal_epa_sites_density_city <- cal_epa_sites_int %>%
                #         mutate(facility_has_violation = case_when(violations_records > 0 ~ 1,
                #                                                   TRUE ~ 0),
                #                facility_has_enforcement = case_when(enforcement_records > 0 ~ 1,
                #                                                     TRUE ~ 0)) %>% 
                #         group_by(redline_city, holc_grade, data_source) %>% 
                #         summarize(facility_count = n(),
                #                   violations_total = sum(violations_records),
                #                   violations_facilities = sum(facility_has_violation),
                #                   enforcements_total = sum(enforcement_records),
                #                   enforcements_facilities = sum(facility_has_enforcement)) %>% 
                #         drop_units() %>% 
                #         st_drop_geometry()
                #     # compute the facility density (facilities per square mile)
                #         cal_epa_sites_density_city <- cal_epa_sites_density_city %>% 
                #             left_join(redline_polygons_city_areas) %>% 
                #             mutate(facility_density = facility_count / redline_city_area_mi2,
                #                    violations_total_per_facility = violations_total / facility_count,
                #                    violations_total_per_area = violations_total / redline_city_area_mi2,
                #                    enforcements_total_per_facility = enforcements_total / facility_count,
                #                    enforcements_total_per_area = enforcements_total / redline_city_area_mi2,) %>% 
                #             select(-redline_city_area_m2)                
                    
                    
                # group by city and holc grade (don't classify by data source/ facility type)
                    cal_epa_sites_density_city_all <- cal_epa_sites_int %>%
                        mutate(facility_has_violation = case_when(violations_records > 0 ~ 1,
                                                                  TRUE ~ 0),
                               facility_has_enforcement = case_when(enforcement_records > 0 ~ 1,
                                                                    TRUE ~ 0)) %>% 
                        group_by(redline_city, holc_grade) %>% 
                        summarize(facility_count = n(),
                                  violations_total = sum(violations_records),
                                  violations_facilities = sum(facility_has_violation),
                                  enforcements_total = sum(enforcement_records),
                                  enforcements_facilities = sum(facility_has_enforcement)) %>% 
                        drop_units() %>% 
                        st_drop_geometry()
                    # compute the facility and violations / enforcement density (facilities per square mile)
                        cal_epa_sites_density_city_all <- cal_epa_sites_density_city_all %>% 
                            left_join(redline_polygons_city_areas) %>% 
                            mutate(facility_density = facility_count / redline_city_area_mi2,
                                   violations_total_per_facility = violations_total / facility_count,
                                   violations_total_per_area = violations_total / redline_city_area_mi2,
                                   enforcements_total_per_facility = enforcements_total / facility_count,
                                   enforcements_total_per_area = enforcements_total / redline_city_area_mi2,) %>% 
                            select(-redline_city_area_m2) 
                        
                # plot
                    # transform data to long form (to allow for faceting)
                        cal_epa_sites_density_city_all_long <- cal_epa_sites_density_city_all %>% 
                            select(redline_city:holc_grade, facility_density:enforcements_total_per_area) %>% 
                            pivot_longer(cols = -c(redline_city, holc_grade), names_to = 'measure', values_to = 'value')
                    # filter for the variables to plot and rename
                        cal_epa_sites_density_city_all_long <- cal_epa_sites_density_city_all_long %>% 
                            filter(measure == 'facility_density' |
                                       measure == 'violations_total_per_area' |
                                       measure == 'enforcements_total_per_area') %>%
                            # rename
                            mutate(measure = case_when(measure == 'facility_density' ~ 'Facility Density',
                                                       measure == 'violations_total_per_area' ~ 'Total Violations',
                                                       measure == 'enforcements_total_per_area' ~ 'Total Enforcements',
                                                       TRUE ~ measure))
                        
                    # # make the plot (with facets)
                    # g_facility_plot_all <- ggplot(cal_epa_sites_density_city_all_long) + 
                    #     # aes(x = fct_reorder(redline_city, value), y = value, fill = fct_rev(holc_grade)) + 
                    #     # aes(x = fct_rev(redline_city), y = value, fill = fct_rev(holc_grade)) + 
                    #     aes(x = fct_relevel(redline_city, 
                    #                         rev(c('Fresno', 'Stockton', 'Los Angeles', 'Sacramento', 'San Jose', 'Oakland', 'San Diego', 'San Francisco'))
                    #                         ),
                    #         y = value, 
                    #         fill = fct_rev(holc_grade)) +
                    #     geom_bar(stat = 'identity', position = 'dodge') + 
                    #     # facet_grid(rows = vars(fct_relevel(measure, c('facility_density', 'violations_total_per_facility', 'violations_total_per_area', 'enforcements_total_per_facility', 'enforcements_total_per_area'))), scales = 'free_y') +
                    #     facet_wrap(vars(fct_relevel(measure, c('facility_density', 'violations_total_per_facility', 'violations_total_per_area', 'enforcements_total_per_facility', 'enforcements_total_per_area'))), scales = 'free') +
                    #     scale_fill_manual(values = rev(c('green', 'blue', 'yellow', 'red'))) + 
                    #     guides(fill = guide_legend(reverse = TRUE)) +
                    #     labs(fill = 'HOLC Rating', x = NULL, y = 'Amount per square mile') + 
                    #     coord_flip()
                    # g_facility_plot_all
```

```{r facility density by city and statewide, fig.cap='**Figure 4. Density of facilities by HOLC rating class in each city and statewide.**'}
            # Facility density statewide
                # get the total area of each holc type statewide
                    redline_polygons_state_areas <- redline_polygons %>% 
                        group_by(holc_grade) %>% 
                        summarize(redline_state_area_m2 = sum(redline_poly_area)) %>%
                        mutate(redline_state_area_mi2 = redline_state_area_m2 / 2589988) %>%
                        st_drop_geometry() %>% 
                        drop_units()
                # group by holc grade only (don't classify by data source/ facility type)
                    cal_epa_sites_density_state_all <- cal_epa_sites_int %>%
                        mutate(facility_has_violation = case_when(violations_records > 0 ~ 1,
                                                                  TRUE ~ 0),
                               facility_has_enforcement = case_when(enforcement_records > 0 ~ 1,
                                                                    TRUE ~ 0)) %>% 
                        group_by(holc_grade) %>% 
                        summarize(facility_count = n(),
                                  violations_total = sum(violations_records),
                                  violations_facilities = sum(facility_has_violation),
                                  enforcements_total = sum(enforcement_records),
                                  enforcements_facilities = sum(facility_has_enforcement)) %>% 
                        drop_units() %>% 
                        st_drop_geometry()
                    # compute the facility and violations / enforcement density (facilities per square mile)
                        cal_epa_sites_density_state_all <- cal_epa_sites_density_state_all %>% 
                            left_join(redline_polygons_state_areas) %>% 
                            mutate(facility_density = facility_count / redline_state_area_mi2,
                                   violations_total_per_facility = violations_total / facility_count,
                                   violations_total_per_area = violations_total / redline_state_area_mi2,
                                   enforcements_total_per_facility = enforcements_total / facility_count,
                                   enforcements_total_per_area = enforcements_total / redline_state_area_mi2,) %>% 
                            select(-redline_state_area_m2)
                        
                    # join to the city data
                        cal_epa_sites_density_state_all <- cal_epa_sites_density_state_all %>% 
                            mutate(redline_city = '**Statewide**')
                        
                        cal_epa_sites_density_combined <- bind_rows(cal_epa_sites_density_city_all, cal_epa_sites_density_state_all)
                        
                    # plot facility density data by city and holc rating, and include statewide summary
                        g_facility_density <- ggplot(cal_epa_sites_density_combined) + 
                            # aes(x = fct_relevel(fct_reorder(redline_city, facility_density), c('**Statewide**'), after = 0), 
                            #     y = facility_density, 
                            #     fill = fct_rev(holc_grade)) + 
                            aes(x = fct_relevel(redline_city, 
                                            rev(c('Fresno', 'Stockton', 'Los Angeles', 'Sacramento', 'San Jose', 'Oakland', 'San Diego', 'San Francisco', '**Statewide**'))
                                            ), 
                                y = facility_density, 
                                fill = fct_rev(holc_grade)) +
                            geom_bar(stat = 'identity', position = 'dodge') +
                            geom_vline(xintercept = 1.52, size = 0.5, color = 'grey50') +
                            scale_fill_manual(values = rev(c('green', 'blue', 'yellow', 'red'))) +
                            guides(fill = guide_legend(reverse = TRUE)) +
                            labs(fill = 'HOLC Rating', x = NULL, y = "Density (Number per Square Mile)") +
                            coord_flip()
                        g_facility_density
                        
```

```{r violation rate, fig.cap='**Figure 5. Violation rate (number per square mile) by HOLC rating class in each city and statewide.**'}
# plot facility density data by city and holc rating, and include statewide summary
    g_violation_density <- ggplot(cal_epa_sites_density_combined) + 
        # aes(x = fct_relevel(fct_reorder(redline_city, facility_density), c('**Statewide**'), after = 0), 
        #     y = facility_density, 
        #     fill = fct_rev(holc_grade)) + 
        aes(x = fct_relevel(redline_city, 
                        rev(c('Fresno', 'Stockton', 'Los Angeles', 'Sacramento', 'San Jose', 'Oakland', 'San Diego', 'San Francisco', '**Statewide**'))
                        ), 
            y = violations_total_per_area, 
            fill = fct_rev(holc_grade)) +
        geom_bar(stat = 'identity', position = 'dodge') +
        geom_vline(xintercept = 1.52, size = 0.5, color = 'grey50') +
        scale_fill_manual(values = rev(c('green', 'blue', 'yellow', 'red'))) +
        guides(fill = guide_legend(reverse = TRUE)) +
        labs(fill = 'HOLC Rating', x = NULL, y = "Violation Rate (number of records per square mile)") +
        coord_flip()
    g_violation_density
```

```{r enforcement rate, fig.cap='**Figure 6. Enforcement action rate by HOLC rating class in each city and statewide.**'}
# plot facility density data by city and holc rating, and include statewide summary
    g_enforcement_density <- ggplot(cal_epa_sites_density_combined) + 
        # aes(x = fct_relevel(fct_reorder(redline_city, facility_density), c('**Statewide**'), after = 0), 
        #     y = facility_density, 
        #     fill = fct_rev(holc_grade)) + 
        aes(x = fct_relevel(redline_city, 
                        rev(c('Fresno', 'Stockton', 'Los Angeles', 'Sacramento', 'San Jose', 'Oakland', 'San Diego', 'San Francisco', '**Statewide**'))
                        ), 
            y = enforcements_total_per_area, 
            fill = fct_rev(holc_grade)) +
        geom_bar(stat = 'identity', position = 'dodge') +
        geom_vline(xintercept = 1.52, size = 0.5, color = 'grey50') +
        scale_fill_manual(values = rev(c('green', 'blue', 'yellow', 'red'))) +
        guides(fill = guide_legend(reverse = TRUE)) +
        labs(fill = 'HOLC Rating', x = NULL, y = "Enforcement Rate (number of records per square mile)") +
        coord_flip()
    g_enforcement_density
```